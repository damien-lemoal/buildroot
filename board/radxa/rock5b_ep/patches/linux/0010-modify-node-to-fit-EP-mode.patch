From 3a593b91bfbfbe772b114f57f16963c43a5ecd5a Mon Sep 17 00:00:00 2001
From: Niklas Cassel <niklas.cassel@wdc.com>
Date: Thu, 2 Nov 2023 15:19:52 +0100
Subject: [PATCH 10/41] modify node to fit EP mode

TODO: remove unused interrupts

Signed-off-by: Niklas Cassel <niklas.cassel@wdc.com>
---
 arch/arm64/boot/dts/rockchip/rk3588.dtsi | 35 ++++--------------------
 1 file changed, 6 insertions(+), 29 deletions(-)

diff --git a/arch/arm64/boot/dts/rockchip/rk3588.dtsi b/arch/arm64/boot/dts/rockchip/rk3588.dtsi
index 9cf63eef0000..88b0bcfab186 100644
--- a/arch/arm64/boot/dts/rockchip/rk3588.dtsi
+++ b/arch/arm64/boot/dts/rockchip/rk3588.dtsi
@@ -143,60 +143,37 @@ pcie3x4_intc: legacy-interrupt-controller {
 	};
 
 	pcie3x4_ep: pcie_ep@fe150000 {
-		compatible = "rockchip,rk3588-pcie", "rockchip,rk3568-pcie";
-		#address-cells = <3>;
-		#size-cells = <2>;
-		bus-range = <0x00 0x0f>;
+		compatible = "rockchip,rk3588-pcie-ep";
 		clocks = <&cru ACLK_PCIE_4L_MSTR>, <&cru ACLK_PCIE_4L_SLV>,
 			 <&cru ACLK_PCIE_4L_DBI>, <&cru PCLK_PCIE_4L>,
 			 <&cru CLK_PCIE_AUX0>, <&cru CLK_PCIE4L_PIPE>;
 		clock-names = "aclk_mst", "aclk_slv",
 			      "aclk_dbi", "pclk",
 			      "aux", "pipe";
-		device_type = "pci";
 		interrupts = <GIC_SPI 263 IRQ_TYPE_LEVEL_HIGH 0>,
 			     <GIC_SPI 262 IRQ_TYPE_LEVEL_HIGH 0>,
 			     <GIC_SPI 261 IRQ_TYPE_LEVEL_HIGH 0>,
-			     <GIC_SPI 260 IRQ_TYPE_LEVEL_HIGH 0>,
 			     <GIC_SPI 259 IRQ_TYPE_LEVEL_HIGH 0>,
 			     <GIC_SPI 271 IRQ_TYPE_LEVEL_HIGH 0>,
 			     <GIC_SPI 272 IRQ_TYPE_LEVEL_HIGH 0>,
 			     <GIC_SPI 269 IRQ_TYPE_LEVEL_HIGH 0>,
 			     <GIC_SPI 270 IRQ_TYPE_LEVEL_HIGH 0>;
-		interrupt-names = "sys", "pmc", "msg", "legacy", "err",
+		interrupt-names = "sys", "pmc", "msg", "err",
 				  "dma0", "dma1", "dma2", "dma3";
-		#interrupt-cells = <1>;
-		interrupt-map-mask = <0 0 0 7>;
-		interrupt-map = <0 0 0 1 &pcie3x4_intc 0>,
-				<0 0 0 2 &pcie3x4_intc 1>,
-				<0 0 0 3 &pcie3x4_intc 2>,
-				<0 0 0 4 &pcie3x4_intc 3>;
-		linux,pci-domain = <0>;
 		max-link-speed = <3>;
-		msi-map = <0x0000 &its1 0x0000 0x1000>;
 		num-lanes = <4>;
 		phys = <&pcie30phy>;
 		phy-names = "pcie-phy";
 		power-domains = <&power RK3588_PD_PCIE>;
-		ranges = <0x01000000 0x0 0xf0100000 0x0 0xf0100000 0x0 0x00100000>,
-			 <0x02000000 0x0 0xf0200000 0x0 0xf0200000 0x0 0x00e00000>,
-			 <0x03000000 0x0 0x40000000 0x9 0x00000000 0x0 0x40000000>;
-		reg = <0xa 0x40000000 0x0 0x00300000>,
+		reg = <0xa 0x40000000 0x0 0x00100000>,
+		      <0xa 0x40100000 0x0 0x00100000>,
 		      <0x0 0xfe150000 0x0 0x00010000>,
-		      <0x0 0xf0000000 0x0 0x00100000>,
+		      <0x9 0x00000000 0x0 0x40000000>,
 		      <0xa 0x40300000 0x0 0x00100000>;
-		reg-names = "dbi", "apb", "config", "atu";
+		reg-names = "dbi", "dbi2", "apb", "addr_space", "atu";
 		resets = <&cru SRST_PCIE0_POWER_UP>, <&cru SRST_P_PCIE0>;
 		reset-names = "pwr", "pipe";
 		status = "disabled";
-
-		pcie3x4_intc: legacy-interrupt-controller {
-			interrupt-controller;
-			#address-cells = <0>;
-			#interrupt-cells = <1>;
-			interrupt-parent = <&gic>;
-			interrupts = <GIC_SPI 260 IRQ_TYPE_EDGE_RISING 0>;
-		};
 	};
 
 	pcie3x2: pcie@fe160000 {
-- 
2.43.0

